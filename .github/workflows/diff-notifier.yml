name: Region history notifier

on:
  push:
    paths:
      - ".region-watch/history/**"
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Collect history changes
        id: history
        run: |
          python - <<'PY'
          import json
          import os
          import subprocess

          rev = os.environ.get("GITHUB_SHA", "").strip()
          if not rev:
              raise SystemExit("Missing GITHUB_SHA")

          result = subprocess.run(
              ["git", "show", "--stat", "--name-only", rev, "--", ".region-watch/history"],
              capture_output=True,
              text=True,
              check=True,
          )

          files = []
          for line in result.stdout.splitlines():
              line = line.strip()
              if not line:
                  continue
              if line.endswith(".json") and ".region-watch/history/" in line:
                  files.append(line)

          output_path = os.environ["GITHUB_OUTPUT"]
          with open(output_path, "a", encoding="utf-8") as handle:
              handle.write(f"files={json.dumps(files)}\n")
          PY

      - name: Prepare summary
        id: summary
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          files = json.loads(os.environ.get("FILES_JSON", "[]"))
          entries = []
          for path in files:
              data = json.loads(Path(path).read_text(encoding="utf-8"))
              timestamp = data.get("timestamp")
              changes = data.get("changes", {})
              if not timestamp or not changes:
                  continue

              model_lines = []
              for model in sorted(changes):
                  change = changes[model]
                  added = change.get("all", {}).get("added", [])
                  removed = change.get("all", {}).get("removed", [])
                  if added:
                      model_lines.append(f"{model}: +{', '.join(added)}")
                  if removed:
                      model_lines.append(f"{model}: -{', '.join(removed)}")
                  for sku_key, sku_change in sorted(change.get("skus", {}).items()):
                      label = sku_change.get("label", sku_key)
                      sku_added = sku_change.get("added", [])
                      sku_removed = sku_change.get("removed", [])
                      if sku_added:
                          model_lines.append(f"  - {label}: +{', '.join(sku_added)}")
                      if sku_removed:
                          model_lines.append(f"  - {label}: -{', '.join(sku_removed)}")
                      if sku_change.get("sku_removed"):
                          model_lines.append(f"  - {label}: SKU removed")
                  if change.get("model_removed"):
                      model_lines.append("  - model removed")

              if model_lines:
                  entries.append({
                      "timestamp": timestamp,
                      "path": path,
                      "details": model_lines,
                  })

          output_path = os.environ["GITHUB_OUTPUT"]
          with open(output_path, "a", encoding="utf-8") as handle:
              handle.write(f"entries={json.dumps(entries)}\n")
          PY
        env:
          FILES_JSON: ${{ steps.history.outputs.files }}

      - name: Create notification issue comment
        if: ${{ steps.summary.outputs.entries != '[]' }}
        uses: actions/github-script@v7
        with:
          script: |
            const entries = JSON.parse(core.getInput('entries'));
            if (!entries.length) {
              core.info('No history entries to report');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = 'Azure AI Foundry model history update';
            const label = 'region-watch';
            const bodyLines = ['History updates detected:'];
            for (const entry of entries) {
              bodyLines.push(`- ${entry.timestamp} (${entry.path})`);
              for (const detail of entry.details) {
                bodyLines.push(`  ${detail}`);
              }
            }
            bodyLines.push('', '/cc @jinle @org/team-name'); // adjust mentions

            const issues = await github.paginate(github.rest.issues.listForRepo, {owner, repo, labels: label, state: 'open'});
            if (issues.length) {
              await github.rest.issues.createComment({owner, repo, issue_number: issues[0].number, body: bodyLines.join('\n')});
            } else {
              await github.rest.issues.create({owner, repo, title, body: bodyLines.join('\n'), labels: [label], assignees: ['jinle']});
            }
        
