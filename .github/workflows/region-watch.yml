name: Region watch (GitHub Markdown)
on:
  schedule: [{ cron: "23 */6 * * *" }]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  watch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install requests

      - name: Run diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # boosts rate limits
        run: |
          python .region-watch/diff_regions_md.py > region_diff.json
          cat region_diff.json

      - name: Commit snapshot if changed
        run: |
          git config user.email "bot@users.noreply.github.com"
          git config user.name "region-bot"
          git add .region-watch/regions_snapshot.json region_diff.json
          git diff --cached --quiet || git commit -m "Update region snapshot"
          git push

      - name: Notify via GitHub issue
        if: ${{ hashFiles('region_diff.json') != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const diff = JSON.parse(fs.readFileSync('region_diff.json','utf8'));
            const hasChange = Object.values(diff.changes || {}).some(c => (c.added||[]).length || (c.removed||[]).length);
            if (!hasChange) { core.info('No region changes'); return; }

            const owner = context.repo.owner, repo = context.repo.repo;
            const title = 'Azure AI model region watch';
            const label = 'region-watch';
            const bodyLines = ['Model region changes detected:'];
            for (const [m, ch] of Object.entries(diff.changes)) {
                if ((ch.added||[]).length)  bodyLines.push(`• ${m}: ADDED -> ${ch.added.join(', ')}`);
                if ((ch.removed||[]).length) bodyLines.push(`• ${m}: REMOVED -> ${ch.removed.join(', ')}`);
            }
            bodyLines.push('\n/cc @jinle @org/team-name'); // adjust mentions

            // find existing open issue
            const issues = await github.paginate(github.rest.issues.listForRepo, {owner, repo, labels: label, state: 'open'});
            if (issues.length) {
                await github.rest.issues.createComment({owner, repo, issue_number: issues[0].number, body: bodyLines.join('\n')});
            } else {
                await github.rest.issues.create({owner, repo, title, body: bodyLines.join('\n'), labels: [label], assignees: ['jinle']});
            }